%global debug_package %{nil}
%global source_date_epoch_from_changelog %{nil}

Name:       @PROJECT_NAME@
Version:	@PROJECT_VERSION_MAJOR@.@PROJECT_VERSION_MINOR@.@PROJECT_VERSION_PATCH@
Release:	@PROJECT_VERSION_RELEASE@%{?dist}
Summary:	@PROJECT_DESCRIPTION@
Group:		System Environment/Libraries
License:	LGPL v3+
Source0:    %{name}-%{version}.tar.gz

BuildRequires: systemd-rpm-macros
BuildRequires: gcc-c++, cmake
BuildRequires: doxygen
BuildRequires: openssl-devel, libcurl-devel, libuv-devel, libwebsockets-devel, protobuf-devel
BuildRequires: json-devel
# BuildRequires: opentelemetry-cpp-devel
# BuildRequires: parquet-libs-devel
BuildRequires: root, root-net-http, root-net-httpsniff
Requires:      root, root-netx, xrootd-client
Requires:      libwebsockets-devel, json-devel

%description
@PROJECT_DESCRIPTION@

%package doc
Summary:  Documentation
Group:    Documentation
Requires: %{name} = %{version}-%{release}, pkgconfig

%description doc
This package contains @PROJECT_NAME@ documentation.

%package server
Summary:  Server for @PROJECT_NAME@
Group:    Additional Packages
Requires: %{name} = %{version}-%{release}, pkgconfig
Requires: root-net-http, root-net-httpsniff

%description server
This package contains server part for @PROJECT_NAME@.

%package jupyroot
Summary:  Jupyroot bindings for @PROJECT_NAME@
Group:    Additional Packages
Requires: %{name} = %{version}-%{release}, pkgconfig
Requires: python3-jupyroot, root-gui-browserv7-v7

%description jupyroot
This package contains Jupyroot bindings for @PROJECT_NAME@.

%prep
%setup -q

%build
mkdir build
cd build
cmake ../ \
-DCMAKE_INSTALL_PREFIX=/usr \
-DCMAKE_BUILD_TYPE=Release \
-DBUILD_DOCUMENTATION=on \
-DWITH_TEST=OFF \
-DWITH_PARQUET=OFF \
-DWITH_OPENTELEMETRY=OFF

make %{?_smp_mflags}
cd ../

%install
rm -rf %{buildroot}
cd build
make install DESTDIR=%{buildroot}

%post server
%systemd_post ndmspc-http@*.service

%preun server
%systemd_preun ndmspc-http@*.service

%postun server
%systemd_postun ndmspc-http@*.service

%preun jupyroot
%systemd_preun ndmspc-notebook@*.service

%postun jupyroot
%systemd_postun ndmspc-notebook@*.service

%post jupyroot
%systemd_post ndmspc-notebook@*.service

%files
%{_libdir}/*
%{_bindir}/ndmspc-run
%{_datadir}/%{name}/*
%{_sysconfdir}/ndmspc/*
%{_sysconfdir}/profile.d/*
%{_includedir}/*

%files doc
%doc /usr/share/doc/%{name}/

%files server
%{_bindir}/ndmspc-server
%{_unitdir}/ndmspc-http@.service
%{_sysconfdir}/systemd/user/ndmspc-http@.service

%files jupyroot
%{_unitdir}/ndmspc-notebook@.service
%{_sysconfdir}/systemd/user/ndmspc-notebook@.service

%changelog
